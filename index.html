<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAT - G√©nero y Liderazgo Pol√≠tico</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 50px;
            max-width: 900px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 { color: #667eea; margin-bottom: 30px; text-align: center; font-size: 2em; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .consent-text { line-height: 1.8; color: #555; margin-bottom: 25px; }
        .consent-text h3 { color: #667eea; margin-top: 25px; margin-bottom: 10px; }
        
        .checkbox-group {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 3px;
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 25px; }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-container { text-align: center; margin-top: 40px; }
        
        .instructions {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            line-height: 1.8;
        }
        
        .instructions h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            margin-left: 25px;
            margin-top: 15px;
        }
        
        .instructions li { margin-bottom: 12px; }
        
        #iat-display {
            width: 100%;
            height: 600px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .iat-header {
            display: flex;
            justify-content: space-between;
            padding: 30px 50px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .iat-category {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .iat-category.left { color: #667eea; }
        .iat-category.right { color: #764ba2; }
        
        .iat-stimulus-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .iat-stimulus img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .iat-stimulus .word {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }
        
        .iat-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: red;
            font-weight: bold;
            display: none;
        }
        
        .iat-footer {
            padding: 20px;
            text-align: center;
            border-top: 2px solid #e0e0e0;
            color: #666;
        }
        
        .iat-instructions {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 40px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }
        
        .result-box h2 {
            color: #667eea;
            margin-bottom: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <!-- SECCI√ìN 1: CONSENTIMIENTO -->
        <div id="consent-section" class="section active">
            <h1>üìã Consentimiento Informado</h1>
            
            <div class="consent-text">
                <h3>Estudio sobre Asociaciones Impl√≠citas</h3>
                <p><strong>Investigador:</strong> [Tu nombre]</p>
                <p><strong>Instituci√≥n:</strong> [Tu instituci√≥n]</p>
                
                <h3>Prop√≥sito</h3>
                <p>Investigar asociaciones autom√°ticas entre conceptos de g√©nero y liderazgo pol√≠tico mediante el Test de Asociaci√≥n Impl√≠cita (IAT).</p>
                
                <h3>Procedimiento</h3>
                <p>Completar√° una tarea de clasificaci√≥n que toma <strong>12-15 minutos</strong>. Ver√° im√°genes y palabras que clasificar√° usando teclas espec√≠ficas.</p>
                
                <h3>Confidencialidad</h3>
                <p>Sus respuestas son <strong>completamente an√≥nimas</strong>. No se recopila informaci√≥n identificatoria.</p>
                
                <h3>Participaci√≥n</h3>
                <p>Su participaci√≥n es <strong>voluntaria</strong>. Puede retirarse en cualquier momento.</p>
            </div>
            
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="consent-check">
                    <span>He le√≠do y comprendo la informaci√≥n. <strong>Acepto participar voluntariamente</strong> y tengo al menos 18 a√±os.</span>
                </label>
            </div>
            
            <div class="btn-container">
                <button id="consent-btn" disabled>Continuar ‚Üí</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 2: DEMOGRAF√çA -->
        <div id="demographics-section" class="section">
            <h1>üë§ Informaci√≥n Demogr√°fica</h1>
            
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Esta informaci√≥n es opcional pero valiosa para el an√°lisis.
            </p>
            
            <div class="form-group">
                <label for="age">Edad:</label>
                <input type="number" id="age" min="18" max="99" placeholder="18-99">
            </div>
            
            <div class="form-group">
                <label for="sex">Sexo:</label>
                <select id="sex">
                    <option value="">Seleccione...</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                    <option value="Prefiero no decir">Prefiero no decir</option>
                </select>
            </div>
            
            <div class="btn-container">
                <button id="demo-btn">Continuar ‚Üí</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 3: INSTRUCCIONES -->
        <div id="instructions-section" class="section">
            <h1>üìñ Instrucciones</h1>
            
            <div class="instructions">
                <h3>¬øQu√© es el IAT?</h3>
                <p>El IAT mide asociaciones autom√°ticas entre conceptos. Mediremos asociaciones entre <strong>g√©nero</strong> y <strong>atributos pol√≠ticos</strong>.</p>
                
                <h3>Qu√© ver√°:</h3>
                <ul>
                    <li>Im√°genes de rostros (hombres y mujeres)</li>
                    <li>Palabras (atributos positivos y negativos del liderazgo)</li>
                </ul>
                
                <h3>C√≥mo responder:</h3>
                <ul>
                    <li>Tecla <strong>E</strong> = Categor√≠a IZQUIERDA</li>
                    <li>Tecla <strong>I</strong> = Categor√≠a DERECHA</li>
                </ul>
                
                <h3>Importante:</h3>
                <ul>
                    <li>‚úÖ Responda lo m√°s <strong>r√°pido posible</strong></li>
                    <li>‚úÖ Minimice errores</li>
                    <li>‚úÖ Si se equivoca, ver√° una "X" roja - presione la tecla correcta</li>
                    <li>‚úÖ Las categor√≠as cambiar√°n - preste atenci√≥n</li>
                    <li>‚úÖ Duraci√≥n: <strong>12-15 minutos</strong></li>
                </ul>
            </div>
            
            <div class="btn-container">
                <button id="instructions-btn">üöÄ Comenzar</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 4: IAT -->
        <div id="iat-section" class="section">
            <div class="iat-instructions" id="block-instructions"></div>
            
            <div id="iat-display">
                <div class="iat-header">
                    <div class="iat-category left" id="left-label"></div>
                    <div class="iat-category right" id="right-label"></div>
                </div>
                
                <div class="iat-stimulus-area">
                    <div class="iat-stimulus" id="stimulus"></div>
                </div>
                
                <div class="iat-error" id="error-x">‚úó</div>
                
                <div class="iat-footer">
                    Presione <strong>E</strong> para IZQUIERDA o <strong>I</strong> para DERECHA
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN 5: RESULTADOS -->
        <div id="results-section" class="section">
            <h1>‚úÖ ¬°Completado!</h1>
            
            <div class="result-box">
                <h2>üéâ Gracias por su participaci√≥n</h2>
                <p style="font-size: 1.2em; margin-top: 20px;">Sus datos han sido registrados exitosamente.</p>
                
                <div style="margin-top: 30px; line-height: 1.8; color: #555;">
                    <p>Sus respuestas contribuir√°n a la investigaci√≥n cient√≠fica sobre cognici√≥n social y asociaciones impl√≠citas.</p>
                    <p style="margin-top: 20px;"><strong>Nota:</strong> El IAT mide tendencias grupales y no es diagn√≥stico individual.</p>
                </div>
            </div>
            
            <div class="btn-container" style="margin-top: 40px;">
                <button onclick="window.close()">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/gh/minnojs/minno-quest@0.3/dist/pi-minno.js"></script>
    
    <script>
    // ===== CONFIGURACI√ìN =====
    const CONFIG = {
        imageBaseURL: 'https://raw.githubusercontent.com/DatoSocial/iat-genero-politica/main/',
        googleScriptURL: '', // Configurar despu√©s
        
        stimuli: {
            hombres: ['hombre1.jpg', 'hombre2.jpg', 'hombre3.jpg', 'hombre4.jpg', 'hombre5.jpg', 'hombre6.jpg', 'hombre7.jpg', 'hombre8.jpg', 'hombre9.jpg'],
            mujeres: ['mujer1.jpg', 'mujer2.jpg', 'mujer3.jpg', 'mujer4.jpg', 'mujer5.jpg', 'mujer6.jpg', 'mujer7.jpg', 'mujer8.jpg', 'mujer9.jpg'],
            positivo: ['Honestidad', 'Competencia', 'Liderazgo', 'Eficiencia', 'Integridad', 'Transparencia'],
            negativo: ['Corrupci√≥n', 'Incompetencia', 'Autoritarismo', 'Ineficiencia', 'Deshonestidad', 'Opacidad']
        }
    };
    
    const participant = {
        id: 'P_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        age: null,
        sex: null,
        orderCondition: null,
        startTime: null,
        completionTime: null,
        trials: []
    };
    
    let currentBlock = 0, currentTrial = 0, blockTrials = [], trialStartTime = 0;
    
    function updateProgress(p) { document.getElementById('progress').style.width = p + '%'; }
    function showSection(id) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }
    function shuffle(arr) { 
        const a = [...arr]; 
        for (let i = a.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [a[i], a[j]] = [a[j], a[i]]; 
        } 
        return a; 
    }
    
    // ===== NAVEGACI√ìN =====
    document.getElementById('consent-check').addEventListener('change', e => {
        document.getElementById('consent-btn').disabled = !e.target.checked;
    });
    
    document.getElementById('consent-btn').addEventListener('click', () => {
        updateProgress(20);
        showSection('demographics-section');
    });
    
    document.getElementById('demo-btn').addEventListener('click', () => {
        const age = parseInt(document.getElementById('age').value);
        const sex = document.getElementById('sex').value;
        
        if (!age || age < 18 || age > 99) { alert('Edad v√°lida 18-99'); return; }
        if (!sex) { alert('Seleccione sexo'); return; }
        
        participant.age = age;
        participant.sex = sex;
        updateProgress(40);
        showSection('instructions-section');
    });
    
    document.getElementById('instructions-btn').addEventListener('click', () => {
        participant.startTime = new Date().toISOString();
        participant.orderCondition = Math.random() < 0.5 ? 'A' : 'B';
        
        console.log('CONDICI√ìN:', participant.orderCondition);
        
        updateProgress(50);
        showSection('iat-section');
        setTimeout(startIAT, 500);
    });
    
    // ===== ESTRUCTURA IAT =====
    function getBlocks() {
        if (participant.orderCondition === 'A') {
            return [
                {num:1, name:'Pr√°ctica g√©nero', trials:18, leftCat:'Hombres', rightCat:'Mujeres', leftStim:CONFIG.stimuli.hombres.slice(0,9), rightStim:CONFIG.stimuli.mujeres.slice(0,9), isImage:true},
                {num:2, name:'Pr√°ctica atributos', trials:12, leftCat:'Positivo', rightCat:'Negativo', leftStim:CONFIG.stimuli.positivo, rightStim:CONFIG.stimuli.negativo, isImage:false},
                {num:3, name:'Combinada 1 pr√°ctica', trials:18, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:4, name:'Combinada 1 test', trials:36, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:5, name:'Inversi√≥n', trials:27, leftCat:'Mujeres', rightCat:'Hombres', leftStim:CONFIG.stimuli.mujeres, rightStim:CONFIG.stimuli.hombres, isImage:true},
                {num:6, name:'Combinada 2 pr√°ctica', trials:18, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:7, name:'Combinada 2 test', trials:36, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'}
            ];
        } else {
            return [
                {num:1, name:'Pr√°ctica g√©nero', trials:18, leftCat:'Hombres', rightCat:'Mujeres', leftStim:CONFIG.stimuli.hombres.slice(0,9), rightStim:CONFIG.stimuli.mujeres.slice(0,9), isImage:true},
                {num:2, name:'Pr√°ctica atributos', trials:12, leftCat:'Positivo', rightCat:'Negativo', leftStim:CONFIG.stimuli.positivo, rightStim:CONFIG.stimuli.negativo, isImage:false},
                {num:3, name:'Combinada 1 pr√°ctica', trials:18, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:4, name:'Combinada 1 test', trials:36, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:5, name:'Inversi√≥n', trials:27, leftCat:'Mujeres', rightCat:'Hombres', leftStim:CONFIG.stimuli.mujeres, rightStim:CONFIG.stimuli.hombres, isImage:true},
                {num:6, name:'Combinada 2 pr√°ctica', trials:18, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:7, name:'Combinada 2 test', trials:36, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'}
            ];
        }
    }
    
    function startIAT() {
        currentBlock = 0;
        currentTrial = 0;
        startBlock();
    }
    
    function startBlock() {
        const blocks = getBlocks();
        if (currentBlock >= blocks.length) { finishIAT(); return; }
        
        const block = blocks[currentBlock];
        updateProgress(50 + (currentBlock / blocks.length) * 40);
        
        document.getElementById('block-instructions').innerHTML = `<strong>Bloque ${block.num} de 7:</strong> ${block.name}`;
        document.getElementById('left-label').textContent = block.leftCat;
        document.getElementById('right-label').textContent = block.rightCat;
        
        blockTrials = [];
        for (let i = 0; i < block.trials; i++) {
            const side = i % 2 === 0 ? 'left' : 'right';
            const stim = side === 'left' ? block.leftStim : block.rightStim;
            const stimulus = stim[Math.floor(Math.random() * stim.length)];
            const isImg = block.isImage === 'mixed' ? stimulus.endsWith('.jpg') : block.isImage;
            blockTrials.push({block: block.num, stimulus, correctSide: side, isImage: isImg});
        }
        blockTrials = shuffle(blockTrials);
        currentTrial = 0;
        
        setTimeout(showTrial, 1000);
    }
    
    function showTrial() {
        const blocks = getBlocks();
        if (currentTrial >= blockTrials.length) { currentBlock++; startBlock(); return; }
        
        const trial = blockTrials[currentTrial];
        const stimEl = document.getElementById('stimulus');
        
        if (trial.isImage) {
            stimEl.innerHTML = `<img src="${CONFIG.imageBaseURL}${trial.stimulus}">`;
        } else {
            stimEl.innerHTML = `<div class="word">${trial.stimulus}</div>`;
        }
        
        trialStartTime = performance.now();
        document.addEventListener('keydown', handleKey);
    }
    
    function handleKey(e) {
        if (e.key !== 'e' && e.key !== 'E' && e.key !== 'i' && e.key !== 'I') return;
        
        e.preventDefault();
        document.removeEventListener('keydown', handleKey);
        
        const trial = blockTrials[currentTrial];
        const side = (e.key === 'e' || e.key === 'E') ? 'left' : 'right';
        const correct = side === trial.correctSide;
        const rt = Math.round(performance.now() - trialStartTime);
        
        participant.trials.push({
            participantID: participant.id,
            block: trial.block,
            trial: currentTrial + 1,
            stimulus: trial.stimulus,
            isImage: trial.isImage,
            correctSide: trial.correctSide,
            pressedKey: e.key,
            pressedSide: side,
            correct,
            rt
        });
        
        if (correct) {
            currentTrial++;
            setTimeout(showTrial, 250);
        } else {
            document.getElementById('error-x').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-x').style.display = 'none';
                trialStartTime = performance.now();
                document.addEventListener('keydown', handleKey);
            }, 300);
        }
    }
    
    function finishIAT() {
        participant.completionTime = new Date().toISOString();
        updateProgress(95);
        
        const dScore = calculateDScore(participant.trials);
        participant.dScore = dScore.d_score;
        participant.dScoreData = dScore;
        
        console.log('D-score:', dScore.d_score);
        
        if (CONFIG.googleScriptURL) {
            fetch(CONFIG.googleScriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(participant)
            }).catch(err => console.error(err));
        } else {
            console.log('Datos:', participant);
        }
        
        updateProgress(100);
        showSection('results-section');
    }
    
    function calculateDScore(allTrials) {
        const trials = allTrials.filter(t => [3,4,6,7].includes(t.block));
        let filtered = trials.filter(t => t.rt <= 10000);
        
        const fastRate = trials.filter(t => t.rt < 300).length / trials.length;
        if (fastRate > 0.10) return {valid: false, error: 'Excluido', d_score: null};
        
        const b3 = filtered.filter(t => t.block === 3);
        const b4 = filtered.filter(t => t.block === 4);
        const b6 = filtered.filter(t => t.block === 6);
        const b7 = filtered.filter(t => t.block === 7);
        
        function applyPenalty(blk) {
            const mean = blk.filter(t => t.correct).reduce((a,b) => a+b.rt, 0) / blk.filter(t => t.correct).length;
            return blk.map(t => ({...t, rt_adj: t.correct ? t.rt : mean + 600}));
        }
        
        const b3a = applyPenalty(b3), b4a = applyPenalty(b4), b6a = applyPenalty(b6), b7a = applyPenalty(b7);
        
        const m3 = b3a.reduce((a,b) => a+b.rt_adj, 0) / b3a.length;
        const m4 = b4a.reduce((a,b) => a+b.rt_adj, 0) / b4a.length;
        const m6 = b6a.reduce((a,b) => a+b.rt_adj, 0) / b6a.length;
        const m7 = b7a.reduce((a,b) => a+b.rt_adj, 0) / b7a.length;
        
        function sd(trials) {
            const mean = trials.reduce((a,b) => a+b.rt_adj, 0) / trials.length;
            const variance = trials.reduce((a,b) => a + Math.pow(b.rt_adj - mean, 2), 0) / (trials.length - 1);
            return Math.sqrt(variance);
        }
        
        const sdp = sd([...b3a, ...b6a]);
        const sdt = sd([...b4a, ...b7a]);
        
        const dp = (m6 - m3) / sdp;
        const dt = (m7 - m4) / sdt;
        const d = (dp + dt) / 2;
        
        return {valid: true, d_score: parseFloat(d.toFixed(3)), d_practice: parseFloat(dp.toFixed(3)), d_test: parseFloat(dt.toFixed(3))};
    }
    </script>
</body>
</html>