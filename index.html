<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAT - G√©nero y Liderazgo Pol√≠tico</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            padding: 50px;
            max-width: 900px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 { color: #2c3e50; margin-bottom: 30px; text-align: center; font-size: 2em; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2c3e50 0%, #34495e 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .consent-text { line-height: 1.8; color: #555; margin-bottom: 25px; }
        .consent-text h3 { color: #2c3e50; margin-top: 25px; margin-bottom: 10px; }
        
        .checkbox-group {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 3px;
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 25px; }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #2c3e50;
        }
        
        button {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(44, 62, 80, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-container { text-align: center; margin-top: 40px; }
        
        .instructions {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            line-height: 1.8;
            border: 2px solid #e0e0e0;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            margin-left: 25px;
            margin-top: 15px;
        }
        
        .instructions li { margin-bottom: 12px; }
        
        #iat-display {
            width: 100%;
            height: 600px;
            background: white;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .iat-header {
            display: flex;
            justify-content: space-between;
            padding: 30px 50px;
            border-bottom: 3px solid #2c3e50;
            background: #f8f9fa;
        }
        
        .iat-category {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .iat-category.left { 
            color: #2c3e50; 
            border: 3px solid #2c3e50;
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
        }
        
        .iat-category.right { 
            color: #34495e; 
            border: 3px solid #34495e;
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
        }
        
        .iat-stimulus-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: white;
        }
        
        .iat-stimulus img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid #2c3e50;
        }
        
        .iat-stimulus .word {
            font-size: 42px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .iat-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: #e74c3c;
            font-weight: bold;
            display: none;
            text-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }
        
        .iat-correct {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: #27ae60;
            font-weight: bold;
            display: none;
            text-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }
        
        .iat-footer {
            padding: 20px;
            text-align: center;
            border-top: 3px solid #2c3e50;
            color: #2c3e50;
            font-weight: 600;
            background: #f8f9fa;
        }
        
        .iat-instructions {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 2px solid #2c3e50;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Pantalla entre bloques */
        .block-break {
            display: none;
            text-align: center;
            padding: 60px 40px;
        }
        
        .block-break.active {
            display: block;
        }
        
        .block-break h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 30px;
        }
        
        .block-break .message {
            font-size: 1.3em;
            line-height: 1.8;
            color: #555;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #2c3e50;
        }
        
        .block-break .emphasis {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
        }
        
        /* Resultados */
        .result-box {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            border: 3px solid #2c3e50;
        }
        
        .result-box h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2em;
        }
        
        .result-box .score-display {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
            border: 3px solid #2c3e50;
        }
        
        .result-box .score-label {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 15px;
        }
        
        .result-box .score-value {
            font-size: 3.5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }
        
        .result-box .interpretation {
            font-size: 1.3em;
            color: #2c3e50;
            font-weight: 600;
            margin-top: 15px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 2px solid #2c3e50;
        }
        
        .result-box .explanation {
            margin-top: 30px;
            line-height: 1.8;
            color: #555;
            text-align: left;
        }
        
        /* Precarga de im√°genes */
        .preload-images {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 1px;
            height: 1px;
        }
    </style>
</head>
<body>
    <!-- Precarga de im√°genes -->
    <div class="preload-images" id="preload"></div>
    
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <!-- SECCI√ìN 1: CONSENTIMIENTO -->
        <div id="consent-section" class="section active">
            <h1>üìã Consentimiento Informado</h1>
            
            <div class="consent-text">
                <h3>Estudio sobre Asociaciones Impl√≠citas</h3>
                <p><strong>Investigador:</strong> [Tu nombre]</p>
                <p><strong>Instituci√≥n:</strong> [Tu instituci√≥n]</p>
                
                <h3>Prop√≥sito</h3>
                <p>Investigar asociaciones autom√°ticas entre conceptos de g√©nero y liderazgo pol√≠tico mediante el Test de Asociaci√≥n Impl√≠cita (IAT).</p>
                
                <h3>Procedimiento</h3>
                <p>Completar√° una tarea de clasificaci√≥n que toma <strong>12-15 minutos</strong>. Ver√° im√°genes y palabras que clasificar√° usando teclas espec√≠ficas.</p>
                
                <h3>Confidencialidad</h3>
                <p>Sus respuestas son <strong>completamente an√≥nimas</strong>. No se recopila informaci√≥n identificatoria.</p>
                
                <h3>Participaci√≥n</h3>
                <p>Su participaci√≥n es <strong>voluntaria</strong>. Puede retirarse en cualquier momento.</p>
            </div>
            
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="consent-check">
                    <span>He le√≠do y comprendo la informaci√≥n. <strong>Acepto participar voluntariamente</strong> y tengo al menos 18 a√±os.</span>
                </label>
            </div>
            
            <div class="btn-container">
                <button id="consent-btn" disabled>Continuar ‚Üí</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 2: DEMOGRAF√çA -->
        <div id="demographics-section" class="section">
            <h1>üë§ Informaci√≥n Demogr√°fica</h1>
            
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Esta informaci√≥n es opcional pero valiosa para el an√°lisis.
            </p>
            
            <div class="form-group">
                <label for="age">Edad:</label>
                <input type="number" id="age" min="18" max="99" placeholder="18-99">
            </div>
            
            <div class="form-group">
                <label for="sex">Sexo:</label>
                <select id="sex">
                    <option value="">Seleccione...</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                    <option value="Prefiero no decir">Prefiero no decir</option>
                </select>
            </div>
            
            <div class="btn-container">
                <button id="demo-btn">Continuar ‚Üí</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 3: INSTRUCCIONES -->
        <div id="instructions-section" class="section">
            <h1>üìñ Instrucciones</h1>
            
            <div class="instructions">
                <h3>¬øQu√© es el IAT?</h3>
                <p>El IAT mide asociaciones autom√°ticas entre conceptos. Mediremos asociaciones entre <strong>g√©nero</strong> y <strong>atributos pol√≠ticos</strong>.</p>
                
                <h3>Qu√© ver√°:</h3>
                <ul>
                    <li>Im√°genes de rostros (hombres y mujeres)</li>
                    <li>Palabras (atributos positivos y negativos del liderazgo)</li>
                </ul>
                
                <h3>C√≥mo responder:</h3>
                <ul>
                    <li>Tecla <strong>E</strong> = Categor√≠a IZQUIERDA</li>
                    <li>Tecla <strong>I</strong> = Categor√≠a DERECHA</li>
                </ul>
                
                <h3>Importante:</h3>
                <ul>
                    <li>‚úÖ Responda lo m√°s <strong>r√°pido posible</strong></li>
                    <li>‚úÖ Minimice errores</li>
                    <li>‚úÖ Si acierta, ver√° un "‚úì" verde brevemente</li>
                    <li>‚úÖ Si se equivoca, ver√° una "‚úó" roja - presione la tecla correcta</li>
                    <li>‚úÖ Las categor√≠as cambiar√°n - preste atenci√≥n</li>
                    <li>‚úÖ Habr√° pausas entre bloques para descansar</li>
                    <li>‚úÖ Duraci√≥n: <strong>12-15 minutos</strong></li>
                </ul>
            </div>
            
            <div class="btn-container">
                <button id="instructions-btn">üöÄ Comenzar</button>
            </div>
        </div>
        
        <!-- SECCI√ìN 4: PANTALLA ENTRE BLOQUES -->
        <div id="block-break-section" class="section">
            <div class="block-break active">
                <h2 id="break-title"></h2>
                <div class="message" id="break-message"></div>
                <div class="emphasis" id="break-emphasis"></div>
                <div class="btn-container">
                    <button id="continue-btn">Continuar ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN 5: IAT -->
        <div id="iat-section" class="section">
            <div class="iat-instructions" id="block-instructions"></div>
            
            <div id="iat-display">
                <div class="iat-header">
                    <div class="iat-category left" id="left-label"></div>
                    <div class="iat-category right" id="right-label"></div>
                </div>
                
                <div class="iat-stimulus-area">
                    <div class="iat-stimulus" id="stimulus"></div>
                </div>
                
                <div class="iat-error" id="error-x">‚úó</div>
                <div class="iat-correct" id="correct-check">‚úì</div>
                
                <div class="iat-footer">
                    Presione <strong>E</strong> para IZQUIERDA o <strong>I</strong> para DERECHA
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN 6: RESULTADOS -->
        <div id="results-section" class="section">
            <h1>‚úÖ ¬°Test Completado!</h1>
            
            <div class="result-box">
                <h2>üéâ Gracias por su participaci√≥n</h2>
                
                <div class="score-display">
                    <div class="score-label">Su D-score (Puntaje de Asociaci√≥n Impl√≠cita):</div>
                    <div class="score-value" id="final-dscore">--</div>
                    <div class="interpretation" id="final-interpretation">--</div>
                </div>
                
                <div class="explanation">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">¬øQu√© significa este puntaje?</h3>
                    
                    <p style="margin-bottom: 15px;"><strong>D-score:</strong> Es una medida estandarizada de la diferencia en tiempo de reacci√≥n entre las dos tareas combinadas del IAT. Var√≠a t√≠picamente entre -2.0 y +2.0.</p>
                    
                    <p style="margin-bottom: 15px;"><strong>Interpretaci√≥n de magnitud:</strong></p>
                    <ul style="margin-left: 25px; margin-bottom: 15px;">
                        <li><strong>|D| < 0.15:</strong> Sin asociaci√≥n autom√°tica</li>
                        <li><strong>0.15 ‚â§ |D| < 0.35:</strong> Asociaci√≥n leve</li>
                        <li><strong>0.35 ‚â§ |D| < 0.65:</strong> Asociaci√≥n moderada</li>
                        <li><strong>|D| ‚â• 0.65:</strong> Asociaci√≥n fuerte</li>
                    </ul>
                    
                    <p style="margin-top: 20px;"><strong>Nota importante:</strong> El IAT mide asociaciones autom√°ticas a nivel grupal y no es diagn√≥stico individual. Los resultados reflejan asociaciones que pueden estar influenciadas por la exposici√≥n cultural y no necesariamente reflejan creencias conscientes o intenciones personales.</p>
                    
                    <p style="margin-top: 20px;">Sus datos han sido registrados y contribuir√°n a la investigaci√≥n cient√≠fica sobre cognici√≥n social.</p>
                </div>
            </div>
            
            <div style="margin-top: 40px; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 10px; border: 2px solid #2c3e50;">
                <p style="font-size: 1.3em; color: #2c3e50; font-weight: 600;">Gracias. Puede cerrar esta pesta√±a.</p>
            </div>
        </div>
    </div>
    
    <script>
    // ===== CONFIGURACI√ìN =====
    const CONFIG = {
        imageBaseURL: 'https://raw.githubusercontent.com/DatoSocial/iat-genero-politica/main/',
        googleScriptURL: '',
        showCorrectFeedback: true, // Mostrar ‚úì verde en respuestas correctas
        correctFeedbackDuration: 150, // ms
        
        stimuli: {
            hombres: ['hombre1.jpg', 'hombre2.jpg', 'hombre3.jpg', 'hombre4.jpg', 'hombre5.jpg', 'hombre6.jpg', 'hombre7.jpg', 'hombre8.jpg', 'hombre9.jpg'],
            mujeres: ['mujer1.jpg', 'mujer2.jpg', 'mujer3.jpg', 'mujer4.jpg', 'mujer5.jpg', 'mujer6.jpg', 'mujer7.jpg', 'mujer8.jpg', 'mujer9.jpg'],
            positivo: ['Honestidad', 'Competencia', 'Liderazgo', 'Eficiencia', 'Integridad', 'Transparencia'],
            negativo: ['Corrupci√≥n', 'Incompetencia', 'Autoritarismo', 'Ineficiencia', 'Deshonestidad', 'Opacidad']
        }
    };
    
    // Precargar im√°genes
    function preloadImages() {
        const preloadDiv = document.getElementById('preload');
        const allImages = [...CONFIG.stimuli.hombres, ...CONFIG.stimuli.mujeres];
        
        allImages.forEach(img => {
            const imgEl = document.createElement('img');
            imgEl.src = CONFIG.imageBaseURL + img;
            preloadDiv.appendChild(imgEl);
        });
        
        console.log('‚úÖ Precargando', allImages.length, 'im√°genes...');
    }
    
    // Precargar al cargar la p√°gina
    window.addEventListener('load', preloadImages);
    
    const participant = {
        id: 'P_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        age: null,
        sex: null,
        orderCondition: null,
        startTime: null,
        completionTime: null,
        trials: []
    };
    
    let currentBlock = 0, currentTrial = 0, blockTrials = [], trialStartTime = 0;
    let lastStimulus = null; // Para evitar repeticiones consecutivas
    
    function updateProgress(p) { document.getElementById('progress').style.width = p + '%'; }
    function showSection(id) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }
    function shuffle(arr) { 
        const a = [...arr]; 
        for (let i = a.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [a[i], a[j]] = [a[j], a[i]]; 
        }
        
        // Verificar y corregir repeticiones consecutivas
        for (let i = 1; i < a.length; i++) {
            if (a[i].stimulus === a[i-1].stimulus) {
                // Buscar una posici√≥n donde no haya repetici√≥n
                for (let k = i + 1; k < a.length; k++) {
                    if (a[k].stimulus !== a[i-1].stimulus && 
                        (k === a.length - 1 || a[k].stimulus !== a[k+1].stimulus)) {
                        [a[i], a[k]] = [a[k], a[i]];
                        break;
                    }
                }
            }
        }
        
        return a; 
    }
    
    // ===== NAVEGACI√ìN =====
    document.getElementById('consent-check').addEventListener('change', e => {
        document.getElementById('consent-btn').disabled = !e.target.checked;
    });
    
    document.getElementById('consent-btn').addEventListener('click', () => {
        updateProgress(20);
        showSection('demographics-section');
    });
    
    document.getElementById('demo-btn').addEventListener('click', () => {
        const age = parseInt(document.getElementById('age').value);
        const sex = document.getElementById('sex').value;
        
        if (!age || age < 18 || age > 99) { alert('Edad v√°lida 18-99'); return; }
        if (!sex) { alert('Seleccione sexo'); return; }
        
        participant.age = age;
        participant.sex = sex;
        updateProgress(40);
        showSection('instructions-section');
    });
    
    document.getElementById('instructions-btn').addEventListener('click', () => {
        participant.startTime = new Date().toISOString();
        participant.orderCondition = Math.random() < 0.5 ? 'A' : 'B';
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('CONDICI√ìN:', participant.orderCondition);
        console.log(participant.orderCondition === 'A' ? 
            'Hombres+Positivo primero' : 
            'Mujeres+Positivo primero');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        updateProgress(50);
        currentBlock = 0;
        showBlockBreak();
    });
    
    // ===== PANTALLAS ENTRE BLOQUES =====
    const blockMessages = {
        0: {
            title: 'Bloque 1 de 7',
            message: 'En este bloque practicar√° clasificando <strong>rostros</strong> como <strong>Hombres</strong> o <strong>Mujeres</strong>.',
            emphasis: 'Recuerde: E = Izquierda, I = Derecha'
        },
        1: {
            title: 'Bloque 2 de 7',
            message: 'Ahora practicar√° clasificando <strong>palabras</strong> como <strong>Positivo</strong> o <strong>Negativo</strong>.',
            emphasis: 'Responda lo m√°s r√°pido posible'
        },
        2: {
            title: 'Bloque 3 de 7',
            message: 'Ahora combinar√° ambas tareas. Clasificar√° tanto <strong>rostros</strong> como <strong>palabras</strong> usando las mismas teclas.',
            emphasis: 'Preste atenci√≥n a las categor√≠as en la parte superior'
        },
        3: {
            title: 'Bloque 4 de 7',
            message: 'Continuar√° con la misma tarea combinada. Intente ser <strong>r√°pido y preciso</strong>.',
            emphasis: ''
        },
        4: {
            title: '¬°ATENCI√ìN! Bloque 5 de 7',
            message: '<strong style="color: #e74c3c;">Las categor√≠as han cambiado de lado.</strong> Preste mucha atenci√≥n a las nuevas posiciones.',
            emphasis: '¬°Las categor√≠as de g√©nero est√°n en posiciones opuestas!'
        },
        5: {
            title: 'Bloque 6 de 7',
            message: 'Ahora combinar√° de nuevo rostros y palabras con las <strong>nuevas posiciones</strong> de las categor√≠as.',
            emphasis: 'Recuerde las nuevas posiciones'
        },
        6: {
            title: 'Bloque 7 de 7 - ¬°√öltimo bloque!',
            message: 'Este es el √∫ltimo bloque. Contin√∫e clasificando rostros y palabras con las mismas categor√≠as.',
            emphasis: '¬°√öltimo esfuerzo!'
        }
    };
    
    function showBlockBreak() {
        if (currentBlock >= 7) {
            finishIAT();
            return;
        }
        
        const msg = blockMessages[currentBlock];
        document.getElementById('break-title').textContent = msg.title;
        document.getElementById('break-message').innerHTML = msg.message;
        document.getElementById('break-emphasis').textContent = msg.emphasis;
        
        showSection('block-break-section');
    }
    
    document.getElementById('continue-btn').addEventListener('click', () => {
        showSection('iat-section');
        setTimeout(startBlock, 500);
    });
    
    // ===== ESTRUCTURA IAT =====
    function getBlocks() {
        if (participant.orderCondition === 'A') {
            return [
                {num:1, trials:18, leftCat:'Hombres', rightCat:'Mujeres', leftStim:CONFIG.stimuli.hombres.slice(0,9), rightStim:CONFIG.stimuli.mujeres.slice(0,9), isImage:true},
                {num:2, trials:12, leftCat:'Positivo', rightCat:'Negativo', leftStim:CONFIG.stimuli.positivo, rightStim:CONFIG.stimuli.negativo, isImage:false},
                {num:3, trials:18, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:4, trials:36, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:5, trials:27, leftCat:'Mujeres', rightCat:'Hombres', leftStim:CONFIG.stimuli.mujeres, rightStim:CONFIG.stimuli.hombres, isImage:true},
                {num:6, trials:18, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:7, trials:36, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'}
            ];
        } else {
            return [
                {num:1, trials:18, leftCat:'Hombres', rightCat:'Mujeres', leftStim:CONFIG.stimuli.hombres.slice(0,9), rightStim:CONFIG.stimuli.mujeres.slice(0,9), isImage:true},
                {num:2, trials:12, leftCat:'Positivo', rightCat:'Negativo', leftStim:CONFIG.stimuli.positivo, rightStim:CONFIG.stimuli.negativo, isImage:false},
                {num:3, trials:18, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:4, trials:36, leftCat:'Mujeres o Positivo', rightCat:'Hombres o Negativo', leftStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:5, trials:27, leftCat:'Mujeres', rightCat:'Hombres', leftStim:CONFIG.stimuli.mujeres, rightStim:CONFIG.stimuli.hombres, isImage:true},
                {num:6, trials:18, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'},
                {num:7, trials:36, leftCat:'Hombres o Positivo', rightCat:'Mujeres o Negativo', leftStim:[...CONFIG.stimuli.hombres,...CONFIG.stimuli.positivo], rightStim:[...CONFIG.stimuli.mujeres,...CONFIG.stimuli.negativo], isImage:'mixed'}
            ];
        }
    }
    
    function startBlock() {
        const blocks = getBlocks();
        const block = blocks[currentBlock];
        
        updateProgress(50 + ((currentBlock + 1) / blocks.length) * 40);
        
        document.getElementById('block-instructions').innerHTML = `<strong>Bloque ${block.num} de 7</strong>`;
        document.getElementById('left-label').textContent = block.leftCat;
        document.getElementById('right-label').textContent = block.rightCat;
        
        // Generar trials con anti-repetici√≥n
        blockTrials = [];
        lastStimulus = null; // Resetear al inicio de cada bloque
        
        for (let i = 0; i < block.trials; i++) {
            const side = i % 2 === 0 ? 'left' : 'right';
            const stim = side === 'left' ? block.leftStim : block.rightStim;
            
            // Seleccionar est√≠mulo evitando repetir el anterior
            let stimulus;
            let attempts = 0;
            do {
                stimulus = stim[Math.floor(Math.random() * stim.length)];
                attempts++;
            } while (stimulus === lastStimulus && stim.length > 1 && attempts < 10);
            
            lastStimulus = stimulus;
            
            const isImg = block.isImage === 'mixed' ? stimulus.endsWith('.jpg') : block.isImage;
            blockTrials.push({block: block.num, stimulus, correctSide: side, isImage: isImg});
        }
        
        blockTrials = shuffle(blockTrials);
        currentTrial = 0;
        
        setTimeout(showTrial, 250);
    }
    
    function showTrial() {
        if (currentTrial >= blockTrials.length) { 
            currentBlock++; 
            showBlockBreak();
            return; 
        }
        
        const trial = blockTrials[currentTrial];
        const stimEl = document.getElementById('stimulus');
        
        // Actualizar lastStimulus para el siguiente trial
        lastStimulus = trial.stimulus;
        
        if (trial.isImage) {
            stimEl.innerHTML = `<img src="${CONFIG.imageBaseURL}${trial.stimulus}" alt="Est√≠mulo">`;
        } else {
            stimEl.innerHTML = `<div class="word">${trial.stimulus}</div>`;
        }
        
        trialStartTime = performance.now();
        document.addEventListener('keydown', handleKey);
    }
    
    function handleKey(e) {
        if (e.key !== 'e' && e.key !== 'E' && e.key !== 'i' && e.key !== 'I') return;
        
        e.preventDefault();
        document.removeEventListener('keydown', handleKey);
        
        const trial = blockTrials[currentTrial];
        const side = (e.key === 'e' || e.key === 'E') ? 'left' : 'right';
        const correct = side === trial.correctSide;
        const rt = Math.round(performance.now() - trialStartTime);
        
        participant.trials.push({
            participantID: participant.id,
            block: trial.block,
            trial: currentTrial + 1,
            stimulus: trial.stimulus,
            isImage: trial.isImage,
            correctSide: trial.correctSide,
            pressedKey: e.key,
            pressedSide: side,
            correct,
            rt
        });
        
        if (correct) {
            if (CONFIG.showCorrectFeedback) {
                document.getElementById('correct-check').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('correct-check').style.display = 'none';
                    currentTrial++;
                    setTimeout(showTrial, 100);
                }, CONFIG.correctFeedbackDuration);
            } else {
                currentTrial++;
                setTimeout(showTrial, 250);
            }
        } else {
            document.getElementById('error-x').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-x').style.display = 'none';
                trialStartTime = performance.now();
                document.addEventListener('keydown', handleKey);
            }, 300);
        }
    }
    
    function finishIAT() {
        participant.completionTime = new Date().toISOString();
        updateProgress(95);
        
        const dScoreResult = calculateDScore(participant.trials);
        participant.dScore = dScoreResult.d_score;
        participant.dScoreData = dScoreResult;
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('IAT COMPLETADO');
        console.log('D-score:', dScoreResult.d_score);
        console.log('Interpretaci√≥n:', dScoreResult.interpretation);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // Mostrar resultado
        if (dScoreResult.valid) {
            document.getElementById('final-dscore').textContent = dScoreResult.d_score.toFixed(3);
            document.getElementById('final-interpretation').textContent = getInterpretationText(dScoreResult.d_score);
        } else {
            document.getElementById('final-dscore').textContent = 'N/A';
            document.getElementById('final-interpretation').textContent = 'Datos no v√°lidos para an√°lisis';
        }
        
        if (CONFIG.googleScriptURL) {
            fetch(CONFIG.googleScriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(participant)
            }).catch(err => console.error(err));
        } else {
            console.log('Datos completos:', participant);
        }
        
        updateProgress(100);
        showSection('results-section');
    }
    
    function getInterpretationText(d) {
        const abs = Math.abs(d);
        let magnitude, direction;
        
        if (abs < 0.15) {
            magnitude = 'Sin asociaci√≥n autom√°tica significativa';
        } else if (abs < 0.35) {
            magnitude = 'Asociaci√≥n autom√°tica LEVE';
        } else if (abs < 0.65) {
            magnitude = 'Asociaci√≥n autom√°tica MODERADA';
        } else {
            magnitude = 'Asociaci√≥n autom√°tica FUERTE';
        }
        
        if (abs < 0.15) {
            direction = '';
        } else if (d > 0) {
            direction = ': Mujeres + Atributos positivos';
        } else {
            direction = ': Hombres + Atributos positivos';
        }
        
        return magnitude + direction;
    }
    
    function calculateDScore(allTrials) {
        const trials = allTrials.filter(t => [3,4,6,7].includes(t.block));
        let filtered = trials.filter(t => t.rt <= 10000);
        
        const fastRate = trials.filter(t => t.rt < 300).length / trials.length;
        if (fastRate > 0.10) return {valid: false, error: 'Excluido: >10% respuestas <300ms', d_score: null, interpretation: null};
        
        const b3 = filtered.filter(t => t.block === 3);
        const b4 = filtered.filter(t => t.block === 4);
        const b6 = filtered.filter(t => t.block === 6);
        const b7 = filtered.filter(t => t.block === 7);
        
        function applyPenalty(blk) {
            const mean = blk.filter(t => t.correct).reduce((a,b) => a+b.rt, 0) / blk.filter(t => t.correct).length;
            return blk.map(t => ({...t, rt_adj: t.correct ? t.rt : mean + 600}));
        }
        
        const b3a = applyPenalty(b3), b4a = applyPenalty(b4), b6a = applyPenalty(b6), b7a = applyPenalty(b7);
        
        const m3 = b3a.reduce((a,b) => a+b.rt_adj, 0) / b3a.length;
        const m4 = b4a.reduce((a,b) => a+b.rt_adj, 0) / b4a.length;
        const m6 = b6a.reduce((a,b) => a+b.rt_adj, 0) / b6a.length;
        const m7 = b7a.reduce((a,b) => a+b.rt_adj, 0) / b7a.length;
        
        function sd(trials) {
            const mean = trials.reduce((a,b) => a+b.rt_adj, 0) / trials.length;
            const variance = trials.reduce((a,b) => a + Math.pow(b.rt_adj - mean, 2), 0) / (trials.length - 1);
            return Math.sqrt(variance);
        }
        
        const sdp = sd([...b3a, ...b6a]);
        const sdt = sd([...b4a, ...b7a]);
        
        const dp = (m6 - m3) / sdp;
        const dt = (m7 - m4) / sdt;
        const d = (dp + dt) / 2;
        
        return {
            valid: true, 
            d_score: parseFloat(d.toFixed(3)), 
            d_practice: parseFloat(dp.toFixed(3)), 
            d_test: parseFloat(dt.toFixed(3)),
            interpretation: getInterpretationText(d)
        };
    }
    </script>
</body>
</html>